!function(a,b){"use strict";var c;a.Posts||(a.Posts={}),c=a.Posts,c.data={postTypes:{},initialServerDate:"",initialServerTimestamp:0,initialClientTimestamp:(new Date).valueOf(),l10n:{sectionCustomizeActionTpl:"",fieldTitleLabel:"",fieldContentLabel:"",fieldExcerptLabel:""},postIdInput:null},c.fetchedPosts={},"undefined"!=typeof _wpCustomizePostsExports&&_.extend(c.data,_wpCustomizePostsExports),a.panelConstructor.posts=c.PostsPanel,a.sectionConstructor.post=c.PostSection,a.controlConstructor.post_discussion_fields=a.controlConstructor.dynamic.extend({initialize:function(b,c){c.params.type="post_discussion_fields",c.params.field_type="checkbox",a.controlConstructor.dynamic.prototype.initialize.call(this,b,c)}}),_.each(c.data.postTypes,function(b){var c,d;c="posts["+b.name+"]",a.panelConstructor[c]||(a.panelConstructor[c]=a.panelConstructor.posts.extend({postType:b})),d="post["+b.name+"]",a.sectionConstructor[d]||(a.sectionConstructor[d]=a.sectionConstructor.post.extend({postType:b}))}),c.parseSettingId=function(a){var b,c={};return b=a.replace(/]/g,"").split("["),"post"!==b[0]&&"postmeta"!==b[0]?null:(c.settingType=b[0],"post"===c.settingType&&3!==b.length||"postmeta"===c.settingType&&4!==b.length?null:(c.postType=b[1],c.postType?(c.postId=parseInt(b[2],10),isNaN(c.postId)||c.postId<=0?null:"postmeta"!==c.settingType||(c.metaKey=b[3],c.metaKey)?c:null):null))},c.getPostUrl=function(c){var d,e;if(d=_.clone(c),e=parseInt(d.post_id,10),!e)throw new Error("Missing post_id param.");return delete d.post_id,d.post_type&&"page"===d.post_type?d.page_id=e:d.p=e,"post"!==c.post_type&&"page"!==c.post_type||delete d.post_type,a.settings.url.home+"?"+b.param(d)},c.getPreviewUrl=function(a){return c.getPostUrl(_.extend({},a,{preview:!0}))},c.insertAutoDraftPost=function(d){var e,f,g=b.Deferred();return e=wp.ajax.post("customize-posts-insert-auto-draft",{"customize-posts-nonce":a.settings.nonce["customize-posts"],wp_customize:"on",post_type:d}),f=function(e){var f,h,i,j;return c.addPostSettings(e.settings),e.postSettingId&&a.has(e.postSettingId)?(f=c.addPostSection(e.postSettingId))?(a.control.each(function(b){var c;"dropdown-pages"===b.params.type&&(c=b.container.find('select[name^="_customize-dropdown-pages-"]'),c.append(new Option(a.Posts.data.l10n.noTitle,e.postId)))}),a.section.has("static_front_page")&&a.section("static_front_page").activate(),h=new a.Menus.AvailableItemModel({id:"post-"+e.postId,title:a.Posts.data.l10n.noTitle,type:"post_type",type_label:a.Posts.data.postTypes[d].labels.singular_name,object:d,object_id:e.postId,url:a.Posts.getPostUrl({post_id:e.postId,post_type:d})}),a.Menus.availableMenuItemsPanel.collection.add(h),i=b("#available-menu-items-post_type-"+d).find(".available-menu-items-list"),j=wp.template("available-menu-item"),i.prepend(j(h.attributes)),void g.resolve({postId:e.postId,section:f,setting:a(e.postSettingId)})):void g.reject("no_section"):void g.reject("no_setting")},e.done(f),e.fail(function(a){var b=a||"";"undefined"!=typeof a.message&&(b=a.message),console.error(b),g.reject(b)}),g.promise()},c.receivePreviewData=function(a){var b=c.previewedQuery.get();a.isPartial?(b=_.clone(b),b.postIds=b.postIds.concat(a.postIds),c.previewedQuery.set(b)):c.previewedQuery.set(a),c.ensurePosts(c.previewedQuery.get().postIds)},c.gatherFetchedPostsData=function(b){var d={};return _.each(b,function(b){var e,f,g,h;e=c.fetchedPosts[b],"nav_menu_item"===e?(g="nav_menu_item["+String(b)+"]",h=a(g),f={postType:e,customizeId:g,section:h?a.section("nav_menu["+String(h.get().nav_menu_term_id)+"]"):null,setting:h}):e?(g="post["+e+"]["+String(b)+"]",f={postType:e,customizeId:g,section:a.section(g),setting:a(g)}):f=null,d[b]=f}),d},c.ensurePosts=function(d){var e,f,g=b.Deferred();return f=_.filter(d,function(a){return!c.fetchedPosts[a]}),0===f.length?(g.resolve(c.gatherFetchedPostsData(d)),g):(e=wp.ajax.post("customize-posts-fetch-settings",{"customize-posts-nonce":a.settings.nonce["customize-posts"],wp_customize:"on",customized:a.previewer.query().customized,post_ids:f}),e.done(function(a){c.addPostSettings(a),_.each(a,function(a,b){"post"===a.type&&c.addPostSection(b)}),g.resolve(c.gatherFetchedPostsData(d))}),e.fail(function(){g.reject()}),g.promise())},c.addPostSettings=function(b){var d=[];return _.each(b,function(b,e){var f,g,h,i,j=c.parseSettingId(e);return j?(d.push(j.postId),c.fetchedPosts[j.postId]=j.postType,f=a(e),void(f||(h=a.settingConstructor[b.type]||a.Setting,i=_.extend({},b,{previewer:a.previewer,dirty:!1}),delete i.value,f=new h(e,b.value,i),a.add(e,f),b.dirty&&(f._dirty=!0,f.callbacks.fireWith(f,[f.get(),f.get()])),a.previewer.send("customize-posts-setting",_.extend({id:e},b))))):(g=e.match(/^nav_menu_item\[(-?\d+)]$/),void(g&&(c.fetchedPosts[parseInt(g[1],10)]="nav_menu_item")))}),_.unique(d)},c.addPostSection=function(d){var e,f,g,h,i,j,k,l;if(f=c.parseSettingId(d),!f||"post"!==f.settingType)throw new Error("Bad setting ID");return(l=c.data.postTypes[f.postType])?l.show_in_customizer?(i="post["+f.postType+"]",h="posts["+f.postType+"]",g="post["+f.postType+"]["+String(f.postId)+"]",a.section.has(g)?a.section(g):(j=a.sectionConstructor[i]||a.sectionConstructor.post,k=b("<div>").html(c.data.l10n.sectionCustomizeActionTpl.replace("%s",a.panel(h).params.title)),e=new j(g,{params:{id:g,panel:h,post_type:f.postType,post_id:f.postId,active:!0,customizeAction:k.text()}}),a.section.add(g,e),e)):null:("undefined"!=typeof console&&console.error&&console.error("Unrecognized post type: "+f.postType),null)},c.sanitizeTitleWithDashes=function(a){var c=b.trim(a).toLowerCase();return c=c.replace(/[^a-z0-9\-_]+/g,"-"),c=c.replace(/--+/g,"-"),c=c.replace(/^-+|-+$/g,"")},c.purgeTrash=function(){a.section.each(function(b){b.extended(c.PostSection)&&"trash"===a(b.id).get().post_status&&(b.active.set(!1),b.collapse(),_.each(b.controls(),function(b){b.container.remove(),a.control.remove(b.id)}),a.section.remove(b.id),b.container.remove(),!0===c.previewedQuery.get().isSingular&&a.previewer.previewUrl(a.settings.url.home),a.remove(b.id),delete c.fetchedPosts[b.params.post_id],"page"===b.params.post_type&&b.removeFromDropdownPagesControls())})},c.updateSettingsQuietly=function(b){var c=a.state("saved").get();_.each(b,function(b,c){var d,e=a(c);e&&!_.isEqual(e.get(),b)&&(d=e._dirty,e.set(b),e._dirty=d)}),a.state("saved").set(c)},c.formatDate=function(a){var b,c=4,d=2;return b=("0000"+a.getFullYear()).substr(-c,c),b+="-"+("00"+(a.getMonth()+1)).substr(-d,d),b+="-"+("00"+a.getDate()).substr(-d,d),b+=" "+("00"+a.getHours()).substr(-d,d),b+=":"+("00"+a.getMinutes()).substr(-d,d),b+=":"+("00"+a.getSeconds()).substr(-d,d)},c.getCurrentTime=function(){var a,b,d;return b=(new Date).valueOf(),a=c.parsePostDate(c.data.initialServerDate),d=b-c.data.initialClientTimestamp,d+=c.data.initialClientTimestamp-c.data.initialServerTimestamp,a.setTime(a.getTime()+d),c.formatDate(a)},c.parsePostDate=function(a){var b=_.map(a.split(/\D/),function(a){return parseInt(a,10)});return new Date(b[0],b[1]-1,b[2],b[3],b[4],b[5])},c.focusControl=function(b){function d(){return e=a.control(b),!!e&&(e.focus(),!0)}var e,f,g,h;d()||(h=b.match(/^post(?:meta)?\[(.+?)]\[(\d+)]/),h&&(g="post["+h[1]+"]["+h[2]+"]",f=a.section(g),f&&f.extended(c.PostSection)&&(f.expand(),f.contentsEmbedded.done(function(){var a=500;_.delay(d,a)}))))},c.ensureButtonsOnDropdownPagesControls=function(){a.control.each(c.addActionButtonsToDropdownPagesControl),a.control.bind("add",c.addActionButtonsToDropdownPagesControl)},c.addActionButtonsToDropdownPagesControl=function(a){"dropdown-pages"===a.params.type&&a.deferred.embedded.done(function(){var d,e,f,g,h,i;d=wp.template("customize-posts-dropdown-pages-inputs"),e=b(d()),f=a.container.find("select"),f.after(e),e.prepend(f),g=e.find(".edit-page"),h=e.find(".create-page"),i=function(a){g.toggle(0!==parseInt(a,10))},i(a.setting.get()),a.setting.bind(i),g.on("click",function(d){d.preventDefault(),c.startEditPostFlow({postId:parseInt(a.setting.get(),10),initiatingButton:b(this),originatingConstruct:a,restorePreviousUrl:!0,returnToOriginatingConstruct:!0})}),h.on("click",function(d){d.preventDefault(),c.startCreatePostFlow({postType:"page",initiatingButton:b(this),originatingConstruct:a,restorePreviousUrl:!0,returnToOriginatingConstruct:!0,breadcrumbReturnCallback:function(b){"publish"===b.setting.get().post_status&&a.setting.set(b.postId)}})})})},c.startCreatePostFlow=function(b){var d,e,f,g="create_post_failure";if(e=_.extend({postType:null,initiatingButton:null,originatingConstruct:null,restorePreviousUrl:!0,returnToOriginatingConstruct:Boolean(b.originatingConstruct),breadcrumbReturnCallback:null},b),!e.postType)throw new Error("Missing postType");return e.initiatingButton&&e.initiatingButton.prop("disabled",!0),f=a.Posts.data.postTypes[e.postType],d=a.Posts.insertAutoDraftPost(e.postType),e.originatingConstruct&&e.originatingConstruct.notifications&&e.originatingConstruct.notifications.remove(g),d.done(function(b){var d,g,h,i=b.section,j=null;i.focus(),f.public?(j=a.previewer.previewUrl.get(),a.previewer.previewUrl(a.Posts.getPreviewUrl({post_type:e.postType,post_id:b.postId}))):a.previewer.refresh(),g={},f.supports.title&&(g.post_title=a.Posts.data.l10n.noTitle),b.setting.set(_.extend({},b.setting.get(),g)),e.returnToOriginatingConstruct&&e.originatingConstruct?(e.restorePreviousUrl&&(h=function(){j=null},a.previewer.previewUrl.bind(h)),d=c.focusConstructWithBreadcrumb(i,e.originatingConstruct),d.done(function(){e.breadcrumbReturnCallback&&e.breadcrumbReturnCallback(b),e.initiatingButton&&e.initiatingButton.focus(),j&&e.restorePreviousUrl&&(a.previewer.previewUrl.unbind(h),a.previewer.previewUrl(j))})):c.focusFirstSectionControlOnceFocusable(i)}),d.fail(function(){e.originatingConstruct&&e.originatingConstruct.notifications&&e.originatingConstruct.notifications.add(g,new a.Notification(g,{message:a.Posts.data.l10n.createPostFailure}))}),d.always(function(){e.initiatingButton&&e.initiatingButton.prop("disabled",!1)}),d},c.startEditPostFlow=function(b){var d,e,f="edit_post_failure";if(d=_.extend({postId:null,initiatingButton:null,originatingConstruct:null,restorePreviousUrl:!0,returnToOriginatingConstruct:Boolean(b.originatingConstruct),breadcrumbReturnCallback:null},b),!d.postId)throw new Error("Missing postId");return d.initiatingButton&&d.initiatingButton.prop("disabled",!0),e=a.Posts.ensurePosts([d.postId]),d.originatingConstruct&&d.originatingConstruct.notifications&&d.originatingConstruct.notifications.remove(f),e.done(function(b){var e,f,g,h=null;e=b[d.postId].section,e.focus(),d.returnToOriginatingConstruct&&d.originatingConstruct?(h=a.previewer.previewUrl.get(),a.previewer.previewUrl(a.Posts.getPreviewUrl({post_type:b[d.postId].postType,post_id:d.postId})),d.restorePreviousUrl&&(g=function(){h=null},a.previewer.previewUrl.bind(g)),f=c.focusConstructWithBreadcrumb(e,d.originatingConstruct),f.done(function(){d.breadcrumbReturnCallback&&d.breadcrumbReturnCallback(b[d.postId]),d.initiatingButton&&d.initiatingButton.focus(),d.restorePreviousUrl&&h&&(a.previewer.previewUrl.unbind(g),a.previewer.previewUrl(h))})):c.focusFirstSectionControlOnceFocusable(e)}),e.fail(function(){d.originatingConstruct&&d.originatingConstruct.notifications&&d.originatingConstruct.notifications.add(f,new a.Notification(f,{message:a.Posts.data.l10n.editPostFailure}))}),e.always(function(){d.initiatingButton&&d.initiatingButton.prop("disabled",!1)}),e},c.focusConstructWithBreadcrumb=function(d,e){var f,g=b.Deferred();return d.focus({completeCallback:function(){d.extended(a.Section)&&_.defer(function(){c.focusFirstSectionControlOnceFocusable(d)})}}),f=function(a){a||(d.expanded.unbind(f),e.focus({completeCallback:function(){g.resolve()}}))},d.expanded.bind(f),g},c.focusFirstSectionControlOnceFocusable=function(b){var c,d,e=b.controls()[0];e&&(c=function(f){f&&(b.active.unbind(c),d=100,_.delay(function(){e.focus({completeCallback:function(){var b=e.container.find("input:first");b.val()===a.Posts.data.l10n.noTitle?b.select():b.focus()}})},d))},b.active.get()?c(!0):b.active.bind(c))},c.preventStaticFrontPageCollision=function(){a("page_for_posts","page_on_front",function(c,d){c.bind(function(a){parseInt(a,10)===parseInt(d.get(),10)&&d.set(0)}),d.bind(function(a){parseInt(a,10)===parseInt(c.get(),10)&&c.set(0)}),a.control("page_for_posts","page_on_front",function(a,e){var f,g;"dropdown-pages"===a.params.type&&"dropdown-pages"===e.params.type&&(f=function(a,b){var c,d;c=parseInt(b,10),d=parseInt(a,10),0!==c&&e.container.find('option[value="'+String(c)+'"]').show(),0!==d&&e.container.find('option[value="'+String(d)+'"]').hide()},g=function(b,c){var d,e;d=parseInt(c,10),e=parseInt(b,10),0!==d&&a.container.find('option[value="'+String(d)+'"]').show(),0!==e&&a.container.find('option[value="'+String(e)+'"]').hide()},b.when(a.deferred.embedded,e.deferred.embedded).done(function(){c.bind(f),f(c.get()),d.bind(g),g(d.get())}))})})},c.ensureAutofocusConstructPosts=function(){var b=[];return _.each(["section","control"],function(d){var e;a.settings.autofocus[d]&&(e=c.parseSettingId(a.settings.autofocus[d]),e&&b.push(e.postId))}),b.length>0&&c.ensurePosts(b),b},b("body").on("keydown",function(a){var c=27;c!==a.which||b(a.target).is("body")||b.contains(b("#customize-controls")[0],a.target)||a.stopImmediatePropagation()}),a.bind("ready",function(){c.postIdInput=b('<input type="hidden" id="post_ID" name="post_ID">'),b("body").append(c.postIdInput),c.previewedQuery=new a.Value,c.previewedQuery.validate=function(a){return _.extend({isSingular:!1,isPostPreview:!1,queriedPostId:0,postIds:[]},a)},c.previewedQuery.set({}),a.previewer.bind("customized-posts",c.receivePreviewData),a.bind("saved",function(a){a.saved_post_setting_values&&c.updateSettingsQuietly(a.saved_post_setting_values),c.purgeTrash()}),a.previewer.bind("edit-post",function(b){var c=a.Posts.ensurePosts([b]);c.done(function(a){var c=a[b];c&&c.section.focus()})}),c.ensureButtonsOnDropdownPagesControls(),c.preventStaticFrontPageCollision(),a.previewer.bind("focus-control",c.focusControl),c.ensureAutofocusConstructPosts()})}(wp.customize,jQuery);